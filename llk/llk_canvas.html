<!doctype html>
<html>
  <head>
    <title>Hello World</title>

	<meta charset="utf-8">
	<style>
	  canvas {border:1px solid black;}
	</style>
	<script src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.8.0.js"></script>
	<script>
	  var state = 0; //状态0 idle, 1 start
      
	  //地图信息结构存储 结点state--- 0:通路 1:有图片 2:图片冻结 10:障碍物
	  var item_map;
	  var path_map;
	  //地图大小(包括边缘.至少要都>2)
	  var wc = 10;
	  var hc = 8;

	  //图片资源生成范围
	  var picCount = 10;

	  //图片资源生成后的存储
	  var items;

	  //被点击过的item记录
	  var src_index;

      //图片资源库
	  var picSrc = [
		  "http://cdn-img.easyicon.net/png/5389/538900.png",
		  "http://cdn-img.easyicon.net/png/5389/538901.png",
		  "http://cdn-img.easyicon.net/png/5389/538902.png",
		  "http://cdn-img.easyicon.net/png/5389/538903.png",
		  "http://cdn-img.easyicon.net/png/5389/538904.png",
		  "http://cdn-img.easyicon.net/png/5389/538905.png",
		  "http://cdn-img.easyicon.net/png/5389/538906.png",
		  "http://cdn-img.easyicon.net/png/5389/538907.png",
		  "http://cdn-img.easyicon.net/png/5389/538908.png",
		  "http://cdn-img.easyicon.net/png/5389/538909.png",
	  ];

	  //以下为canvas使用变量
	  //绘图上下文
	  var context;
	  //绘图大小
	  var size = 50;

	  window.onload = init;

	  function init(){
		  items = new Array();
		  item_map = new Array();
		  path_map = new Array();

		  var canvas = document.getElementById("myCanvas");
		  canvas.width = size * wc;
		  canvas.height = size * hc;
		  canvas.addEventListener('click',click_canvas);
		  context = canvas.getContext("2d");
		  context.fillStyle="#FFFFFF";
	  }

	  function start(){
		 if(state != 0) return;
	     
		 //随机出picCount范围内的数
         var nc = (wc-2)*(hc-2);
		 var h_nc = nc/2;
		 
		 //抽取随机资源库资源
		 for(var i=0; i<nc; ++i)
		 {
			 if(i<h_nc)
			 {
				 items[i] = parseInt(Math.random()*picCount);
			 }
			 else
			 {
				 items[i] = items[i-h_nc];
			 }
		 }
		 
		 //资源打乱
		 for(var i=0; i<nc; ++i)
		 {
			 var r = parseInt(Math.random()*(nc-i))+i;
			 if(r != i)
			 {
				 var temp = items[i];
				 items[i] = items[r];
				 items[r] = temp;
			 }
		 }
		 //console.log(items);
		 
		 //生成资源map--现在只有矩形,可以实现不同关卡
		 var _i=0;
		 for(var i=0;i<hc;++i)
		 {
			 for(var j=0;j<wc;++j)
			 {
				 //生成边缘
				 if(i==0 || i==hc-1 || j==0 || j==wc-1)
				 {
					 item_map.push({"index":-1,"state":0});
				 }
				 else
				 {
					 //生成图片区域
					 item_map.push({"index":_i,"state":1});
					 ++_i;
				 }
			 }
		 }

		 //生成资源链接

         //渲染UI
		 for(var i=0;i<wc*hc;++i)
		 {
			 draw_item(i);
		 }

		 state = 1;

	  }
      
	  function click_signal(index){
		  console.log("click:"+String(index));
		  if(!src_index) src_index = index;
		  else
		  {
			  if(src_index != index && match(src_index,index))
			  {
				  //$(src_item).hide();
				  //$(item).hide();
				  hide_item(src_index);
				  hide_item(index);
				  src_index = null;
				  
			  }
			  else
			  {
				  src_index = index;
			  }
		  }
	  }
	  function match(src_i,dst_i){
	      if(items[item_map[src_i]["index"]] != items[item_map[dst_i]["index"]]) return false;
		  
		  var pax = Number(src_i)%wc;
		  var pay = Math.floor(Number(src_i)/wc);
		  var pbx = Number(dst_i)%wc;
		  var pby = Math.floor(Number(dst_i)/wc);
		  //return connected_recursive(pax,pay,pbx,pby,0,0);
		  return path_bfs(pax,pay,pbx,pby);
	  }
	  
	  function path_bfs(pax,pay,pbx,pby){
		  //辅助队列
		  var queue = new Array();
		  
		  var _path = new Array();
		  _path.push(pay*wc+pax);
		  queue.push({x:pax,y:pay,dir:0,inf:0,path:_path});
		  var _i=0;
		  while(queue.length > 0)
		  {
			  var node = queue.shift();
			  if(node.inf > 2)
			  {
				  console.log("===========continue===========");
				  console.log(node.path.toString());
				  continue;
			  }
			  //console.log("========"+String(_i)+"======"+String(node.x)+":"+String(node.y)+"========");
			  if(node.x == pbx && node.y == pby)
			  {
				  //路径
				  console.log("====find path:====inf:"+String(node.inf));
				  console.log(String(node.path));
				  return true;
			  }
			  //左
			  if(node.dir != 2 && node.x-1>=0 && (item_map[node.y*wc+node.x-1]["state"]==0 || (node.x-1==pbx&&node.y==pby)))
			  {
				  var _inf = node.inf;
				  if(node.dir == 3 || node.dir == 4) _inf += 1;
				  var _path = node.path + [node.y*wc+node.x-1];
				  queue.push({x:node.x-1,y:node.y,dir:1,inf:_inf,path:_path});
			  }
			  
			  //右
			  if(node.dir != 1 && node.x+1<wc && (item_map[node.y*wc+node.x+1]["state"]==0 || (node.x+1==pbx&&node.y==pby)))
			  {
				  var _inf = node.inf;
				  if(node.dir == 3 || node.dir == 4) _inf += 1;
				  var _path = node.path + [node.y*wc+node.x+1];
				  queue.push({x:node.x+1,y:node.y,dir:2,inf:_inf,path:_path});
			  }
			  //上
			  if(node.dir != 4 && node.y-1>=0 && (item_map[(node.y-1)*wc+node.x]["state"]==0 || (node.x==pbx&&node.y-1==pby)))
			  {
				  var _inf = node.inf;
				  if(node.dir == 1 || node.dir == 2) _inf += 1;
				  var _path = node.path + [(node.y-1)*wc+node.x];
				  queue.push({x:node.x,y:node.y-1,dir:3,inf:_inf,path:_path});
			  }
			  //下
			  if(node.dir != 3 && node.y+1<hc && (item_map[(node.y+1)*wc+node.x]["state"]==0 || (node.x==pbx&&node.y+1==pby)))
			  {
				  var _inf = node.inf;
				  if(node.dir == 1 || node.dir == 2) _inf += 1;
				  var _path = node.path + [(node.y+1)*wc+node.x];
				  queue.push({x:node.x,y:node.y+1,dir:4,inf:_inf,path:_path});
			  }
			  ++_i;
		  }
		  return false;
	  }

	  function check_state(){
	  }

	  function hide_item(index){
		  item_map[index]["state"] = 0;
		  draw_item(index);
	  }

	  //绘图封闭函数
	  //根据item_map信息,绘制图片
	  function draw_item(index){
		  if(index < 0 || index >= item_map.length) return;

		  var _state = item_map[index]["state"];
		  if(_state == 1)
		  {
			  var img = new Image();
			  img.src = picSrc[items[item_map[index]["index"]]];
			  var _x = Number(index)%wc;
			  var _y = Math.floor(Number(index)/wc);
			  context.drawImage(img,_x*size,_y*size,size,size);
		  }
		  else if(_state == 0)
		  {
			  var _x = Number(index)%wc;
			  var _y = Math.floor(Number(index)/wc);
			  context.fillRect(_x*size,_y*size,size,size);
		  }
	  }
	  function draw_active(){
		  /*if(src_index)
		  {
			  var _x = Number(src_index)%wc;
			  var _y = Math.floor(Number(src_index)/wc);
			  context.rect(_x*size,_y*size,size,size);
		  }*/
	  }
	  function draw_path(path){
		  
	  }

	  function click_canvas(e){
		  
		  var _x = Math.floor(e.offsetX/size);
		  var _y = Math.floor(e.offsetY/size);
		  //console.log("_x:"+String(_x)+"---_y:"+String(_y));
		  if(_x>0 && _x<wc-1 && _y>0 &&_y<hc-1)
		  {
			  click_signal(_y*wc+_x);
		  }
	  }

	</script>
  </head>
  <body>
    <h1>This is a Hello World start!~</h1>
    <input type="button" value="Start!" onclick="start()"/>
	<hr/>
	<canvas width="500" height="400" id="myCanvas">
	  <p>your browser is not supporded!~</p>
	</canvas>

	<br/>
  </body>
</html>